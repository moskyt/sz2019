%h1 Modul Přežití

%table.table
  %thead
    %tr
      %th
      %th Hlídka
      %th MED
      %th Doprava
      %th Doprovod
      %th Checkin
      %th Večeře
      %th Hotspot
      %th Přespání
      %th Na shromaždišti
  %tbody
    - Team.order(:name).each do |team|
      %tr
        %td= team.number
        %td= link_to team.name, [:admin, team]
        %td= !team.medical_data.blank? ? icon("check", "OK") : icon("times", style: "color: #ddd")
        %td
          - if team.points_survival_travel
            #{team.points_survival_travel} b
          - elsif t = team.train
            #{t[:departure]}-#{t[:arrival]}
          - else
            = icon("times", style: "color: #ddd")
        %td= !team.new_supervisor_data.blank? ? icon("check", "OK") : icon("times", style: "color: #ddd")
        %td
          = team.checkin_photo.file? ? icon("check", "OK") : icon("times", style: "color: #ddd")
          = !team.checkin_data.blank? ? icon("check", "OK") : icon("times", style: "color: #ddd")
        %td= team.points_survival_dinner ? "#{team.points_survival_dinner} b" : icon("times", style: "color: #ddd")
        %td 
          - if team.ts_survival_hotspot
            = team.ts_survival_hotspot 
          - elsif h = team.hotspot
            (#{h[:number]}) #{h[:name]}
          - else
            = icon("times", style: "color: #ddd")
        %td= team.points_survival_night ? "#{team.points_survival_night} b" : icon("times", style: "color: #ddd")
        %td= team.ts_survival_center || icon("times", style: "color: #ddd")

%h3 Hotspoty

%table.table
  %tbody
    - Team::HOTSPOTS.each do |i, x|
      %tr
        %th= i
        %th
          = x[:name]
          %br
          - u = survival_checkin_hotspot_team_url(huid: Team.hotspot_uid(i))
          = link_to u,u
          %br
          - tfn = File.join(Rails.root, "public", "images", "hotspot_#{i}.png")
          - unless File.exist?(tfn)
            - FileUtils.mkdir_p(File.join(Rails.root, "public", "images"))
            - png = RQRCode::QRCode.new(u).as_png(module_px_size: 6)
            - File.open(tfn, "wb"){|f| f.write(png.to_s)}
          = image_tag "hotspot_#{i}.png"
          
        %td
          = x[:detail]
          %p
            - Team.find_each do |t|
              - if t.hotspot and t.hotspot[:number] == i
                = link_to t.name, [:admin, t]
                %br
        %td
          = "#{x[:lat]}N,#{x[:lng]}E"
          %div{id: "mapa-h#{i}", style: "height:300px"}
          :javascript
            $(function() {

              var center = SMap.Coords.fromWGS84(#{x[:lng]}, #{x[:lat]});
              var m = new SMap(JAK.gel("mapa-h#{i}"), center, 14, SMap.DEF_TURIST);
              m.addMarker(center);
            });
          
%h3 Vlaky

- tmap = {}
- Team.find_each{|t| next unless t.train; tmap[t.train] ||= []; tmap[t.train] << t}

%table.table
  %tbody
    - tmap.keys.sort_by{|x| x[:departure]}.each do |tk|
      %tr
        %th #{tk[:departure]} -- #{tk[:arrival]} (#{tk[:number]})
        %td
          %ul
            - tmap[tk].each do |t|
              %li= link_to t.name, [:admin, t]
  
          